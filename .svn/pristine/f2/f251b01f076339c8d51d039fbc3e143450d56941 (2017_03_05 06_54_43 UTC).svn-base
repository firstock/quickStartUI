package com.heaven.controller;

import java.io.File;
import java.io.IOException;
import java.util.HashMap;
import java.io.PrintWriter;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.MultipartHttpServletRequest;
import org.springframework.web.servlet.ModelAndView;

import com.heaven.dto.ProjectBean;
import com.heaven.service.FundSerImpl;
import com.heaven.service.MemberServImpl;
import com.heaven.service.ProjectSerImpl;

@Controller
public class ProjectController {
	@Autowired
	private ProjectSerImpl projectService;
	@Autowired
	private FundSerImpl fundService;
	@Autowired
	private MemberServImpl memberService;

	@RequestMapping(value = "/main.do", method = RequestMethod.GET)
	public ModelAndView goMain() {
		System.out.println("project controller 진입");
		List<ProjectBean> list = projectService.getProjectList();
		System.out.println("dao->service->controller로 돌아옴");

		/*syso
		for (int i = 0; i < list.size(); i++) {
			System.out.println(list.get(i));
		}
		 */
		return new ModelAndView("main/main", "list", list);
	}

	@RequestMapping(value = "/projectAddView.do", method = RequestMethod.GET)
	public ModelAndView goProjectAdd() {
		System.out.println("goProjectAdd메서드 진입");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
		return new ModelAndView("project/projectAdd");
	}

	@RequestMapping(value = "/ProjectAddAction.do", method = RequestMethod.POST)
	public ModelAndView addProject(HttpServletRequest request, MultipartHttpServletRequest mRequest,
			@RequestParam("p_title") String p_title, @RequestParam("p_team") String p_team,
			@RequestParam("p_brief") String p_brief, @RequestParam("p_content") String p_content,
			@RequestParam("p_dday") String p_dday, @RequestParam("p_money") String p_money) {

		ModelAndView mav = new ModelAndView();
		ProjectBean dto = new ProjectBean();

		// 1.session에서 로그인 여부 가져오기
		String p_email = (String) request.getSession().getAttribute("email");

		System.out.println("email=" + p_email + ", p_title" + p_title + ", p_team" + p_team + ", p_brief" + p_brief
				+ ", p_content" + p_content + ", p_dday" + p_dday + ", p_money" + p_money);

		// 2.파일업로드
		boolean isSuccess = false;
		String saveFileName = "";

		String uploadPath = "c:/workspaces/spring_sts/finalHeaven/src/main/webapp/resources/img/upload/";
		File dir = new File(uploadPath);
		if (!dir.isDirectory()) {
			dir.mkdirs();
		}

		Iterator<String> iter = mRequest.getFileNames();

		while (iter.hasNext()) {
			String uploadFileName = iter.next();
			MultipartFile mFile = mRequest.getFile(uploadFileName);
			String originalFilename = mFile.getOriginalFilename();
			saveFileName = originalFilename;

			if (saveFileName != null && !saveFileName.equals(" ")) {
				if (new File(uploadPath + saveFileName).exists()) {
					saveFileName = saveFileName + "_" + System.currentTimeMillis();
				}

				try {
					mFile.transferTo(new File(uploadPath + saveFileName));
					isSuccess = true;
				} catch (IllegalStateException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
					isSuccess = false;
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
					isSuccess = false;
				}
			}
		}

		// 3.service로 접근
		if (isSuccess) {

			dto.setPROJECT_IMG(saveFileName);
			dto.setPROJECT_TITLE(p_title);
			dto.setPROJECT_TEAMNAME(p_team);
			dto.setUSER_EMAIL(p_email);
			dto.setPROJECT_BRIEFING(p_brief);
			dto.setPROJECT_CONTENT(p_content);
			dto.setPROJECT_D_DAY(Integer.parseInt(p_dday));
			dto.setPROJECT_GMONEY(Integer.parseInt(p_money));

			System.out.println("controller dto[ " + dto + " ]");
			projectService.addProject(dto);
			mav.setViewName("redirect:/main.do");

		} else {
			mav.setViewName("redirect:/ProjectAddAction.do");
		}
		return mav;
	}

	@RequestMapping(value="/MyProjectView.do", method=RequestMethod.GET)
	public ModelAndView goMyProject(HttpServletRequest request) {
		ModelAndView mav = projectService.getMyProject(request);
		return mav;
	}

	
	// by J.K. 
	//1. 게시판 전체 보기
	@RequestMapping(value="/ProjectListAction.do", method=RequestMethod.GET)
	public ModelAndView listProject(){
		System.out.println("listProject");
		List<ProjectBean> list = projectService.getProjectList();
		return new ModelAndView("project/project_list","projectList",list);
	}
	
	//2. 클릭한 게시판 보기
	@RequestMapping(value="/project_detailAction.do", method=RequestMethod.GET)
	public ModelAndView detailProject(HttpServletRequest request, HttpServletResponse response, @RequestParam("pNum")int num) throws Exception{
		System.out.println("detailProject num: "+num);
		ProjectBean oneProject = projectService.getDetailProject(num);
		System.out.println("detail: "+oneProject);
		return new ModelAndView("project/project_detail","projectBean",oneProject);
	}
	
	//3. 기부금 선택 보기
	@RequestMapping(value="/project_supportingBtn.do",method=RequestMethod.GET)
	public ModelAndView choosingFund(HttpServletRequest request, HttpServletResponse response,  
			@RequestParam("pNum")int num) throws Exception{
		String email = (String) request.getSession().getAttribute("email");
		System.out.println("email: "+email);
		ProjectBean oneProject = projectService.getDetailProject(num);
		return new ModelAndView("project/project_supportingBtn","projectBean",oneProject);
	}
	
	//후원 결제
	@RequestMapping(value="/project_supporting.do", method=RequestMethod.GET)
	public ModelAndView payFunding(HttpServletRequest request, HttpServletResponse response,
			@RequestParam("money")int fundMoney, @RequestParam("pNum")int num) throws Exception{
		response.setContentType("text/html;charset=UTF-8");
		PrintWriter out = response.getWriter();	
		String email = (String)request.getSession().getAttribute("email");
		int myMoney=memberService.getMyAccount(request);
		//펀딩금액이 보유금액보다 적을 경우.
		if(fundMoney <= myMoney){
			ProjectBean oneProject = new ProjectBean();
			oneProject = projectService.getDetailProject(num);
			String title = oneProject.getPROJECT_TITLE();

			int supporters = fundService.addFund(title, email, fundMoney);//개인 후원 기록
			oneProject = projectService.payFund(num,fundMoney,email, supporters);
			memberService.minusFund(email, fundMoney);//개인 금액 감액.
			System.out.println("come back to project controller");
			out.println("<script>");
			out.println("alert('"+fundMoney+"를 후원하신 "+email+"님 감사합니다! \\n현재 보유 금액은 "+(myMoney-fundMoney)+"입니다.');");
			out.println("location='project_detailAction.do?pNum="+num+"'");
			out.println("</script>");
			out.close();
		//펀딩금액이 보유금액보다 클 경우.
		}else{
			out.println("<script>");
			out.println("alert('죄송합니다. 펀딩금액("+fundMoney+"원)이 보유 금액("+myMoney+"원)보다 많아 충전후, \\n펀딩 부탁드립니다.');");
			out.println("location='MyAccountView.do'");
			out.println("</script>");
			out.close();
		}
		return null;
	}
}
